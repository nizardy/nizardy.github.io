<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUASISI Billiard - Ultimate POS</title>
    <style>
        /* CSS untuk Tampilan Modern & Minimalist */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2c2c2c;
            --primary-color: #00bfa6;
            --text-color: #f0f0f0;
            --subtle-text: #a0a0a0;
            --danger-color: #ff5252;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --border-color: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background-color: var(--surface-color);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .logo { font-size: 1.8rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem; letter-spacing: 1px; flex-shrink: 0; }
        .logo span { color: var(--primary-color); }

        .sidebar-section {
            background-color: var(--bg-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-shrink: 0;
        }

        .sidebar h3 { font-size: 0.9rem; color: var(--subtle-text); font-weight: 500; margin-bottom: 0.5rem; text-transform: uppercase; }
        #time { font-size: 2rem; font-weight: 600; text-align: center; }
        #date { font-size: 1rem; color: var(--primary-color); text-align: center; }

        .revenue-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .revenue-item span:first-child { color: var(--subtle-text); }
        .revenue-item span:last-child { font-weight: 600; font-size: 1.1rem; }
        
        .waiting-list-form { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        #waiting-list-name { flex-grow: 1; padding: 0.5rem; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); }
        #add-to-waiting-list-btn { padding: 0.5rem 0.8rem; border: none; border-radius: 6px; background-color: var(--primary-color); color: var(--bg-color); font-weight: 600; cursor: pointer; }
        #waiting-list-container { list-style: none; margin-top: 1rem; height: 180px; overflow-y: auto; }
        .waiting-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; }
        .waiting-list-item:nth-child(odd) { background-color: var(--surface-color); }
        .waiting-list-item button { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2rem; }
        .notify-btn { background-color: var(--border-color); color: var(--text-color); border: none; padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;}
        
        .sidebar-actions { margin-top: auto; display: flex; flex-direction: column; gap: 1rem; flex-shrink: 0; }
        .sidebar-btn { background-color: var(--primary-color); color: var(--bg-color); border: none; padding: 0.8rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .sidebar-btn:hover { background-color: #00a793; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 191, 166, 0.3); }
        .sidebar-btn.secondary { background-color: var(--border-color); color: var(--text-color); }
        .sidebar-btn.secondary:hover { background-color: #555; box-shadow: 0 4px 12px rgba(100, 100, 100, 0.3); }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column;}
        .main-header-container { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-shrink: 0;}
        .main-header { font-size: 2rem; font-weight: 600; }
        .header-widget { display: flex; gap: 1rem; align-items: stretch; }
        .header-revenue { background-color: var(--surface-color); padding: 0.5rem 1rem; border-radius: 8px; display: flex; gap: 1.5rem; cursor: pointer; transition: background-color 0.3s; }
        .header-revenue:hover { background-color: #3c3c3c; }
        .header-revenue .revenue-item { flex-direction: column; align-items: flex-start; padding: 0; }
        .header-revenue .revenue-item span:first-child { font-size: 0.8rem; }
        .header-revenue .revenue-item span:last-child { font-size: 1.2rem; }

        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .table-card { background-color: var(--surface-color); border-radius: 12px; padding: 1.5rem; border-left: 5px solid; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .table-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .table-card.available { border-color: var(--success-color); }
        .table-card.in-use { border-color: var(--primary-color); }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .table-header h3 { font-size: 1.5rem; }
        .table-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .table-status.available { background-color: rgba(76, 175, 80, 0.2); color: var(--success-color); }
        .table-status.in-use { background-color: rgba(0, 191, 166, 0.2); color: var(--primary-color); }
        .customer-info { min-height: 42px; }
        .customer-name { font-style: italic; color: var(--subtle-text); }
        .customer-type-display { font-size: 0.8rem; font-weight: 500; color: var(--primary-color); }
        .timer-display { font-size: 2.2rem; font-weight: 700; text-align: center; margin-top: 1rem; min-height: 48px; }
        .timer-display.warning { color: var(--danger-color); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .booking-indicator { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; background-color: var(--warning-color); color: var(--bg-color); padding: 2px 6px; border-radius: 4px; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 800px; transform: scale(0.9); transition: transform 0.3s; position: relative; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        #billing-modal .modal-content { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: var(--subtle-text); cursor: pointer; z-index: 10; }
        .modal-section { padding-right: 2rem; }
        #billing-modal .modal-section:last-child { padding-right: 0; border-left: 1px solid var(--border-color); padding-left: 2rem; }
        .modal-title { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: var(--subtle-text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 1rem; font-family: 'Poppins', sans-serif; }
        .timer-controls { display: flex; gap: 1rem; }
        .timer-controls select { flex-grow: 1; }
        .timer-controls button { padding: 0.7rem 1rem; border: none; border-radius: 6px; background-color: var(--primary-color); color: var(--bg-color); font-weight: 600; cursor: pointer; }
        .timer-controls .add-time-btn { background-color: var(--warning-color); }
        .fnb-list { max-height: 150px; overflow-y: auto; margin-top: 1rem; padding-right: 10px; }
        .fnb-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .fnb-controls { display: flex; align-items: center; gap: 0.5rem; }
        .fnb-controls button { background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; }
        .bill-details { margin-top: 1.5rem; }
        .bill-row { display: flex; justify-content: space-between; padding: 0.6rem 0; font-size: 1rem; }
        .bill-row.total { font-size: 1.3rem; font-weight: 600; color: var(--primary-color); border-top: 1px solid var(--border-color); margin-top: 0.5rem; padding-top: 1rem; }
        .payment-section { margin-top: 1rem; }
        .payment-section input { font-weight: 600; }
        .modal-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; }
        .modal-actions button { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn-close-bill { background-color: var(--danger-color); color: white; }
        .btn-save { background-color: var(--primary-color); color: var(--bg-color); }
        .btn-update { background-color: var(--warning-color); color: var(--bg-color); }
        .btn-transfer-sesi { background-color: var(--border-color); color: var(--text-color); }

        /* History Modal Styles */
        #history-modal .modal-content { max-width: 1000px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; padding-right: 2rem; }
        .history-controls { display: flex; gap: 2rem; align-items: center; }
        .history-day-total { font-size: 1.1rem; }
        .history-day-total span { color: var(--subtle-text); }
        .history-table-container { max-height: 60vh; overflow-y: auto; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .history-table th, .history-table td { padding: 0.8rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .history-table th { background-color: var(--bg-color); position: sticky; top: 0; }
        .history-table td:last-child { text-align: right; }
        .edit-history-btn { background-color: var(--warning-color); color: var(--bg-color); border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; }
        
        /* Confirmation & Alert Modal Styles */
        #confirm-modal .modal-content, #alert-modal .modal-content { max-width: 450px; text-align: center; }
        #confirm-message, #alert-message { font-size: 1.1rem; margin: 1rem 0 2rem 0; color: var(--subtle-text); }
        .confirm-actions { display: flex; justify-content: center; gap: 1rem; }
        .confirm-actions button { padding: 0.7rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; }
        #confirm-yes-btn { background-color: var(--danger-color); color: white; }
        #confirm-no-btn { background-color: var(--border-color); color: var(--text-color); }

        /* Booking Modal Styles */
        #booking-modal .modal-content { max-width: 900px; display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
        .booking-form-container { border-right: 1px solid var(--border-color); padding-right: 2rem; }
        .booking-list-container { max-height: 60vh; overflow-y: auto; }
        .booking-list-item { background-color: var(--bg-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .booking-list-item div { line-height: 1.4; }
        .booking-list-item strong { color: var(--primary-color); }
        .delete-booking-btn { background-color: var(--danger-color); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; }

        /* Dashboard Modal Styles */
        #dashboard-modal .modal-content { max-width: 1000px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 2rem; margin-top: 1.5rem; }
        .dashboard-card { background-color: var(--bg-color); padding: 1.5rem; border-radius: 8px; }
        .dashboard-card h4 { margin-bottom: 1rem; color: var(--subtle-text); text-transform: uppercase; font-weight: 500; }
        .peak-hours-chart { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-left: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding-top: 10px; }
        .chart-bar { width: 15px; background-color: var(--primary-color); text-align: center; position: relative; }
        .chart-bar span { font-size: 0.7rem; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); }
        .pie-chart-container { display: flex; align-items: center; gap: 1.5rem; }
        .pie-chart { width: 150px; height: 150px; border-radius: 50%; position: relative; }
        .pie-chart-legend { list-style: none; }
        .pie-chart-legend li { margin-bottom: 0.5rem; display: flex; align-items: center; font-size: 0.9rem; }
        .legend-color-box { width: 12px; height: 12px; border-radius: 2px; margin-right: 0.5rem; }
        .occupancy-rate { font-size: 2.5rem; font-weight: 700; text-align: center; }
        .smart-alert-item { background-color: var(--surface-color); padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem; }

        /* F&B Menu Grid */
        .fnb-menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; max-height: 180px; overflow-y: auto; margin-top: 1rem; padding: 0.5rem; background-color: var(--bg-color); border-radius: 8px; }
        .fnb-menu-item { background-color: var(--surface-color); padding: 0.8rem; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .fnb-menu-item:hover { background-color: var(--primary-color); color: var(--bg-color); transform: scale(1.05); }
        .fnb-menu-item .price { font-size: 0.8rem; color: var(--subtle-text); }
        .fnb-menu-item:hover .price { color: var(--bg-color); }
        
        /* Spotify & AI Section */
        .spotify-widget { margin-top: 1.5rem; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">DUASISI<span>Billiard</span></div>
        <div class="sidebar-section datetime">
            <h3 id="date">Selasa, 19 Agu 2025</h3>
            <div id="time">12:00:00</div>
        </div>
        <div class="sidebar-section waiting-list">
            <h3>Daftar Tunggu</h3>
            <div class="waiting-list-form">
                <input type="text" id="waiting-list-name" placeholder="Nama Pelanggan">
                <button id="add-to-waiting-list-btn">+</button>
            </div>
            <ul id="waiting-list-container"></ul>
        </div>
        <div class="sidebar-section spotify-widget">
            <h3>Now Playing</h3>
            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX0A8zVl7p8EV?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
        <div class="sidebar-actions">
            <button class="sidebar-btn" id="takeAwayBtn">Transaksi Langsung</button>
            <button class="sidebar-btn secondary" id="historyBtn">Riwayat Transaksi</button>
            <button class="sidebar-btn secondary" id="bookingBtn">Manajemen Booking</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="main-header-container">
            <h1 class="main-header">Manajemen Meja</h1>
            <div class="header-widget">
                <div class="header-revenue" id="header-revenue-widget">
                    <div class="revenue-item">
                        <span>Harian</span>
                        <span id="daily-revenue">Rp 0</span>
                    </div>
                    <div class="revenue-item">
                        <span>Bulanan</span>
                        <span id="monthly-revenue">Rp 0</span>
                    </div>
                </div>
                <button class="sidebar-btn" id="dashboardBtn">Dashboard Analitik</button>
            </div>
        </div>
        <div class="tables-grid" id="tables-grid"></div>
    </main>

    <!-- Modal for Billing -->
    <div class="modal-overlay" id="billing-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <div class="modal-section">
                <h2 class="modal-title" id="modal-title">Tagihan Meja 1</h2>
                <div class="form-group"><label for="customer-name">Nama Pelanggan</label><input type="text" id="customer-name" placeholder="Masukkan nama"></div>
                <div class="form-group"><label for="customer-type">Tipe Pelanggan</label><select id="customer-type"><option value="Regular">Regular</option><option value="Member">Member (Diskon 10%)</option><option value="Owner">Owner (Diskon 100%)</option></select></div>
                <div id="billiard-section">
                    <div class="form-group"><label>Manajemen Waktu</label><div class="timer-controls"><select id="timer-mode"><option value="fixed">Durasi Tetap (Countdown)</option><option value="open">Open Bill (Stopwatch)</option></select><button id="start-timer-btn">Mulai</button></div></div>
                    <div class="form-group" id="fixed-duration-group"><label for="fixed-duration">Pilih Durasi</label><div class="timer-controls"><select id="fixed-duration"></select><button class="add-time-btn" id="add-time-btn" disabled>+1 Jam</button></div></div>
                </div>
                <div class="form-group">
                    <label>Tambah Makanan & Minuman</label>
                    <div id="fnb-menu-grid" class="fnb-menu-grid"></div>
                </div>
                <div class="fnb-list" id="bill-items-list"></div>
            </div>
            <div class="modal-section">
                <h2 class="modal-title">Rincian Tagihan</h2>
                <div class="bill-details">
                    <div class="bill-row"><span>Waktu Main</span><span id="bill-time-cost">Rp 0</span></div>
                    <div class="bill-row"><span>F&B</span><span id="bill-fnb-cost">Rp 0</span></div>
                    <div id="bill-fnb-details-list" style="padding-left: 1rem; font-size: 0.9em; color: var(--subtle-text);"></div>
                    <hr style="border-color: var(--border-color); margin: 0.5rem 0;">
                    <div class="bill-row"><span>Subtotal</span><span id="bill-subtotal">Rp 0</span></div>
                    <div class="bill-row"><span>Diskon (<span id="discount-percentage">0</span>%)</span><span id="bill-discount">Rp 0</span></div>
                    <div class="bill-row"><span>Deposit</span><span id="bill-deposit" style="color: var(--success-color);">Rp 0</span></div>
                    <div class="bill-row"><span>Pajak (11%)</span><span id="bill-tax">Rp 0</span></div>
                    <div class="bill-row total"><span>TOTAL</span><span id="bill-total">Rp 0</span></div>
                </div>
                <div class="payment-section">
                    <div class="form-group">
                        <label for="payment-method">Metode Pembayaran</label>
                        <select id="payment-method">
                            <option value="Cash">Cash</option>
                            <option value="Non-Cash">Non-Cash</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="amount-paid">Jumlah Bayar</label><input type="text" id="amount-paid" placeholder="Rp 0"></div>
                    <div class="bill-row"><span>Kembalian</span><span id="bill-change">Rp 0</span></div>
                </div>
            </div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <!-- Modal for History -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-content">
            <span class="modal-close" id="history-modal-close-btn">&times;</span>
            <div class="history-header">
                <h2 class="modal-title">Riwayat Transaksi</h2>
                <div class="history-controls">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="history-date-filter">Tampilkan Tanggal:</label>
                        <input type="date" id="history-date-filter">
                    </div>
                    <div class="history-day-total">
                        <span>Total Hari Ini:</span>
                        <strong id="history-day-total-amount">Rp 0</strong>
                    </div>
                </div>
            </div>
            <div class="history-table-container">
                <table class="history-table">
                    <thead><tr><th>Waktu</th><th>Nama Transaksi</th><th>Pelanggan</th><th>Total</th><th>Metode Bayar</th><th>Aksi</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Confirmation -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <h2 class="modal-title">Konfirmasi Aksi</h2>
            <p id="confirm-message">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="confirm-actions"><button id="confirm-no-btn">Tidak</button><button id="confirm-yes-btn">Ya, Lanjutkan</button></div>
        </div>
    </div>
    
    <!-- Modal for Custom Alert -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal-content">
            <h2 class="modal-title">Peringatan</h2>
            <p id="alert-message" style="margin: 1rem 0 2rem 0;"></p>
            <button id="alert-ok-btn" class="sidebar-btn">OK</button>
        </div>
    </div>

    <!-- Modal for Booking -->
    <div class="modal-overlay" id="booking-modal">
        <div class="modal-content">
            <span class="modal-close" id="booking-modal-close-btn">&times;</span>
            <div class="booking-form-container">
                <h2 class="modal-title">Buat Reservasi</h2>
                <form id="booking-form">
                    <div class="form-group"><label for="booking-name">Nama Pelanggan</label><input type="text" id="booking-name" required></div>
                    <div class="form-group"><label for="booking-table">Pilih Meja</label><select id="booking-table" required></select></div>
                    <div class="form-group"><label for="booking-date">Tanggal</label><input type="date" id="booking-date" required></div>
                    <div class="form-group"><label for="booking-time">Jam</label><input type="time" id="booking-time" required></div>
                    <div class="form-group"><label for="booking-deposit">Deposit (Opsional)</label><input type="text" id="booking-deposit" placeholder="Rp 0"></div>
                    <button type="submit" class="sidebar-btn">Buat Booking</button>
                </form>
            </div>
            <div class="booking-list-container">
                <h2 class="modal-title">Daftar Reservasi</h2>
                <div id="booking-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Dashboard -->
    <div class="modal-overlay" id="dashboard-modal">
        <div class="modal-content">
            <span class="modal-close" id="dashboard-modal-close-btn">&times;</span>
            <div class="dashboard-header">
                <h2 class="modal-title">Dashboard Analitik</h2>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="dashboard-date-filter">Tampilkan Tanggal:</label>
                    <input type="date" id="dashboard-date-filter">
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h4>Grafik Jam Sibuk</h4>
                    <div class="peak-hours-chart" id="peak-hours-chart"></div>
                </div>
                <div class="dashboard-card">
                    <h4>Top 5 Item Terlaris</h4>
                    <div class="pie-chart-container">
                        <div id="pie-chart" class="pie-chart"></div>
                        <ul id="pie-chart-legend" class="pie-chart-legend"></ul>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h4>Tingkat Okupansi Meja</h4>
                    <div class="occupancy-rate" id="occupancy-rate">0%</div>
                </div>
                <div class="dashboard-card">
                    <h4>Notifikasi Cerdas</h4>
                    <div id="smart-alerts"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Bill Management (Transfer) -->
    <div class="modal-overlay" id="management-modal">
        <div class="modal-content">
            <span class="modal-close" id="management-modal-close-btn">&times;</span>
            <h2 class="modal-title" id="management-modal-title">Manajemen Tagihan</h2>
            <div id="management-modal-content" style="max-height: 60vh; overflow-y: auto; padding-right: 1rem;"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button id="management-confirm-btn" class="sidebar-btn">Konfirmasi</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- KONFIGURASI APLIKASI ---
            const TOTAL_TABLES = 8;
            const BILLIARD_RATE_PER_HOUR = 40000;
            const TAX_RATE = 0.11;
            const FNB_MENU = [
                { id: 1, name: 'Air Mineral', price: 5000 },
                { id: 2, name: 'Coca-Cola', price: 8000 },
                { id: 3, name: 'Kopi Hitam', price: 10000 },
                { id: 4, name: 'French Fries', price: 20000 },
                { id: 5, name: 'Nasi Goreng', price: 25000 },
            ];

            // --- ELEMEN DOM ---
            const timeEl = document.getElementById('time');
            const dateEl = document.getElementById('date');
            const dailyRevenueEl = document.getElementById('daily-revenue');
            const monthlyRevenueEl = document.getElementById('monthly-revenue');
            const tablesGrid = document.getElementById('tables-grid');
            const takeAwayBtn = document.getElementById('takeAwayBtn');
            const historyBtn = document.getElementById('historyBtn');
            const bookingBtn = document.getElementById('bookingBtn');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const headerRevenueWidget = document.getElementById('header-revenue-widget');

            const billingModal = document.getElementById('billing-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitle = document.getElementById('modal-title');
            const customerNameInput = document.getElementById('customer-name');
            const customerTypeSelect = document.getElementById('customer-type');
            const timerModeSelect = document.getElementById('timer-mode');
            const fixedDurationGroup = document.getElementById('fixed-duration-group');
            const fixedDurationSelect = document.getElementById('fixed-duration');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const addTimeBtn = document.getElementById('add-time-btn');
            const fnbMenuGrid = document.getElementById('fnb-menu-grid');
            const billItemsList = document.getElementById('bill-items-list');
            const billFnbDetailsList = document.getElementById('bill-fnb-details-list');
            const billiardSection = document.getElementById('billiard-section');
            const amountPaidInput = document.getElementById('amount-paid');
            const modalActionsContainer = document.getElementById('modal-actions');
            
            const historyModal = document.getElementById('history-modal');
            const historyModalCloseBtn = document.getElementById('history-modal-close-btn');
            const historyTableBody = document.getElementById('history-table-body');
            const historyDateFilter = document.getElementById('history-date-filter');
            const historyDayTotalAmount = document.getElementById('history-day-total-amount');

            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            const waitingListNameInput = document.getElementById('waiting-list-name');
            const addToWaitingListBtn = document.getElementById('add-to-waiting-list-btn');
            const waitingListContainer = document.getElementById('waiting-list-container');
            
            const bookingModal = document.getElementById('booking-modal');
            const bookingModalCloseBtn = document.getElementById('booking-modal-close-btn');
            const bookingForm = document.getElementById('booking-form');
            const bookingTableSelect = document.getElementById('booking-table');
            const bookingList = document.getElementById('booking-list');
            const bookingDepositInput = document.getElementById('booking-deposit');
            
            const dashboardModal = document.getElementById('dashboard-modal');
            const dashboardModalCloseBtn = document.getElementById('dashboard-modal-close-btn');
            const dashboardDateFilter = document.getElementById('dashboard-date-filter');
            const peakHoursChart = document.getElementById('peak-hours-chart');
            const pieChartEl = document.getElementById('pie-chart');
            const pieChartLegendEl = document.getElementById('pie-chart-legend');
            const occupancyRateEl = document.getElementById('occupancy-rate');
            const smartAlertsEl = document.getElementById('smart-alerts');
            
            const managementModal = document.getElementById('management-modal');
            const managementModalCloseBtn = document.getElementById('management-modal-close-btn');
            const managementModalTitle = document.getElementById('management-modal-title');
            const managementModalContent = document.getElementById('management-modal-content');
            const managementConfirmBtn = document.getElementById('management-confirm-btn');
            
            // --- MANAJEMEN STATE ---
            let appState = {};

            let currentTransactionId = null;
            let currentEditingHistoryId = null;
            let editingTxBuffer = null;
            let actionToConfirm = null;
            let managementAction = null;
            let mainInterval;

            // --- FUNGSI UTILITAS ---
            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            const formatTime = (seconds) => {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(Math.floor(seconds % 60)).padStart(2, '0');
                return `${h}:${m}:${s}`;
            };
            const formatDateTime = (timestamp) => new Date(timestamp).toLocaleString('id-ID', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });
            
            const saveState = () => localStorage.setItem('duasisiBilliardState', JSON.stringify(appState));
            const loadState = () => {
                const savedState = localStorage.getItem('duasisiBilliardState');
                if (savedState) {
                    appState = JSON.parse(savedState);
                } else {
                    appState = {
                        transactions: [],
                        completedTransactions: [],
                        waitingList: [],
                        bookings: [],
                        analytics: {},
                        revenue: {
                            daily: { date: null, total: 0 },
                            monthly: { month: null, total: 0 }
                        }
                    };
                    for (let i = 1; i <= TOTAL_TABLES; i++) {
                        appState.transactions.push(createEmptyTransaction(`table-${i}`, `Meja ${i}`));
                    }
                }
                if (!appState.waitingList) appState.waitingList = [];
                if (!appState.bookings) appState.bookings = [];
                if (!appState.analytics) appState.analytics = {};
            };
            
            const createEmptyTransaction = (id, defaultName) => ({
                id, name: defaultName, customerName: '', customerType: 'Regular', status: 'available',
                timer: { mode: 'fixed', startTime: null, duration: 0, elapsed: 0 },
                items: [],
                bill: { timeCost: 0, fnbCost: 0, subtotal: 0, discount: 0, tax: 0, total: 0, deposit: 0 },
                isTakeAway: id.startsWith('takeaway')
            });

            // --- LOGIKA INTI ---
            function updateClock() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('it-IT');
                dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
            }
            
            function updateRevenueDisplay() {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const thisMonth = now.getFullYear() + '-' + (now.getMonth() + 1);

                if (appState.revenue.daily.date !== today) {
                    appState.revenue.daily = { date: today, total: 0 };
                    if (!appState.analytics[today]) {
                        appState.analytics[today] = { peakHours: {}, topItems: {} };
                    }
                }
                if (appState.revenue.monthly.month !== thisMonth) appState.revenue.monthly = { month: thisMonth, total: 0 };

                dailyRevenueEl.textContent = formatCurrency(appState.revenue.daily.total);
                monthlyRevenueEl.textContent = formatCurrency(appState.revenue.monthly.total);
                saveState();
            }

            function renderTables() {
                tablesGrid.innerHTML = '';
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;

                appState.transactions.forEach(tx => {
                    if (tx.isTakeAway) return;
                    const card = document.createElement('div');
                    card.className = `table-card ${tx.status}`;
                    card.dataset.id = tx.id;
                    const elapsedSeconds = tx.timer.startTime ? (Date.now() - tx.timer.startTime) / 1000 + tx.timer.elapsed : tx.timer.elapsed;
                    let timeDisplay = '--:--:--';
                    let isWarning = false;
                    if (tx.status === 'in-use') {
                        if (tx.timer.mode === 'open') {
                            timeDisplay = formatTime(elapsedSeconds);
                        } else {
                            const remaining = tx.timer.duration - elapsedSeconds;
                            if (remaining <= 0) { timeDisplay = 'Waktu Habis!'; isWarning = true; }
                            else { timeDisplay = formatTime(remaining); if (remaining <= 300) isWarning = true; }
                        }
                    }
                    
                    const hasBookingToday = appState.bookings.some(b => b.tableId === tx.id && b.date === todayStr);

                    card.innerHTML = `
                        ${hasBookingToday ? '<div class="booking-indicator">Booked</div>' : ''}
                        <div class="table-header"><h3>${tx.name}</h3><span class="table-status ${tx.status}">${tx.status === 'in-use' ? 'Digunakan' : 'Tersedia'}</span></div>
                        <div class="customer-info">
                            <p class="customer-name">${tx.customerName || '...'}</p>
                            ${tx.status === 'in-use' ? `<p class="customer-type-display">${tx.customerType}</p>` : ''}
                        </div>
                        <div class="timer-display ${isWarning ? 'warning' : ''}">${timeDisplay}</div>`;
                    card.addEventListener('click', () => handleTableClick(tx.id));
                    tablesGrid.appendChild(card);
                });
            }

            function calculateBill(tx) {
                const fnbCost = tx.items.reduce((acc, item) => acc + (item.price * item.qty), 0);
                let timeCost;

                if (tx.historyId) {
                    timeCost = tx.bill.timeCost;
                } else {
                    if (tx.status === 'in-use' && tx.timer.startTime) {
                        const elapsedSeconds = (Date.now() - tx.timer.startTime) / 1000 + tx.timer.elapsed;
                        timeCost = tx.timer.mode === 'open' ? (elapsedSeconds / 3600) * BILLIARD_RATE_PER_HOUR : Math.ceil(tx.timer.duration / 3600) * BILLIARD_RATE_PER_HOUR;
                    } else if (tx.timer.mode === 'fixed') {
                        timeCost = Math.ceil(tx.timer.duration / 3600) * BILLIARD_RATE_PER_HOUR;
                    } else {
                        timeCost = 0;
                    }
                }

                const subtotal = timeCost + fnbCost;
                let discountRate = 0;
                if (tx.customerType === 'Member') discountRate = 0.10;
                if (tx.customerType === 'Owner') discountRate = 1.00;
                
                const discount = subtotal * discountRate;
                const deposit = tx.bill.deposit || 0;
                const taxableAmount = subtotal - discount;
                const tax = taxableAmount * TAX_RATE;
                const total = taxableAmount + tax - deposit;
                
                const newBill = { timeCost, fnbCost, subtotal, discount, deposit, tax, total };
                return { ...newBill, discountRate: discountRate * 100 };
            }
            
            function updateBillDisplay(bill, items = []) {
                document.getElementById('bill-time-cost').textContent = formatCurrency(bill.timeCost);
                document.getElementById('bill-fnb-cost').textContent = formatCurrency(bill.fnbCost);
                document.getElementById('bill-subtotal').textContent = formatCurrency(bill.subtotal);
                document.getElementById('discount-percentage').textContent = bill.discountRate;
                document.getElementById('bill-discount').textContent = `- ${formatCurrency(bill.discount)}`;
                document.getElementById('bill-deposit').textContent = `- ${formatCurrency(bill.deposit)}`;
                document.getElementById('bill-tax').textContent = formatCurrency(bill.tax);
                document.getElementById('bill-total').textContent = formatCurrency(bill.total < 0 ? 0 : bill.total);
                
                billFnbDetailsList.innerHTML = '';
                if (items.length > 0) {
                    items.forEach(item => {
                        const detailEl = document.createElement('div');
                        detailEl.className = 'bill-row';
                        detailEl.style.padding = '0.2rem 0';
                        detailEl.innerHTML = `<span>- ${item.name} x${item.qty}</span><span>${formatCurrency(item.price * item.qty)}</span>`;
                        billFnbDetailsList.appendChild(detailEl);
                    });
                }

                updateChange();
            }

            function updateChange() {
                const totalText = document.getElementById('bill-total').textContent.replace(/[^0-9]/g, '');
                const total = totalText ? parseFloat(totalText) : 0;
                const paidText = amountPaidInput.value.replace(/[^0-9]/g, '');
                const paid = paidText ? parseInt(paidText, 10) : 0;
                const change = paid - total;
                document.getElementById('bill-change').textContent = formatCurrency(change > 0 ? change : 0);
            }

            function handleTableClick(txId) {
                const tx = appState.transactions.find(t => t.id === txId);
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                const bookingForTable = appState.bookings.find(b => b.tableId === txId && b.date === todayStr);

                if (tx.status === 'available') {
                    if (bookingForTable) {
                        currentTransactionId = txId;
                        actionToConfirm = 'assignFromBooking';
                        confirmMessage.innerHTML = `Meja ini dibooking oleh <strong>${bookingForTable.customerName}</strong>. Mulai sesi untuk booking ini?`;
                        confirmYesBtn.textContent = 'Ya, Mulai Sesi';
                        confirmModal.classList.add('show');
                    } else if (appState.waitingList.length > 0 && !tx.customerName) {
                        currentTransactionId = txId;
                        actionToConfirm = 'assignFromWaitingList';
                        const nextCustomer = appState.waitingList[0];
                        confirmMessage.innerHTML = `Tetapkan meja ini untuk <strong>${nextCustomer.name}</strong>?`;
                        confirmYesBtn.textContent = 'Ya, Tetapkan';
                        confirmModal.classList.add('show');
                    } else {
                        openBillingModal(txId);
                    }
                } else {
                    openBillingModal(txId);
                }
            }

            function openBillingModal(txId, isEditingHistory = false, historyTx = null) {
                let tx;
                if (isEditingHistory) {
                    editingTxBuffer = JSON.parse(JSON.stringify(historyTx));
                    tx = editingTxBuffer;
                    currentEditingHistoryId = tx.historyId;
                } else {
                    tx = appState.transactions.find(t => t.id === txId);
                    currentTransactionId = tx.id;
                }
                if (!tx) return;

                modalTitle.textContent = tx.name;
                customerNameInput.value = tx.customerName;
                customerTypeSelect.value = tx.customerType;
                billiardSection.style.display = tx.isTakeAway ? 'none' : 'block';
                
                timerModeSelect.value = tx.timer.mode;
                fixedDurationSelect.value = tx.timer.duration / 3600 || '1';
                fixedDurationGroup.style.display = tx.timer.mode === 'fixed' ? 'block' : 'none';
                startTimerBtn.disabled = tx.status === 'in-use';
                addTimeBtn.disabled = tx.status !== 'in-use' || tx.timer.mode !== 'fixed';

                renderBillItems(tx);
                const currentBill = calculateBill(tx);
                updateBillDisplay(currentBill, tx.items);
                amountPaidInput.value = '';

                modalActionsContainer.innerHTML = '';
                if (isEditingHistory) {
                    const updateBtn = document.createElement('button');
                    updateBtn.className = 'btn-update';
                    updateBtn.textContent = 'Simpan & Rekalkulasi';
                    updateBtn.onclick = () => showConfirmation('updateHistory');
                    modalActionsContainer.appendChild(updateBtn);
                } else {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'btn-close-bill';
                    closeBtn.textContent = 'Tutup & Bayar Tagihan';
                    closeBtn.onclick = handleAttemptCloseBill;
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'btn-save';
                    saveBtn.textContent = 'Simpan Perubahan';
                    saveBtn.onclick = handleSaveBill;

                    const transferBtn = document.createElement('button');
                    transferBtn.className = 'btn-transfer-sesi';
                    transferBtn.textContent = 'Transfer Sesi';
                    transferBtn.onclick = () => {
                        managementAction = 'transfer';
                        openManagementModal();
                    };
                    
                    modalActionsContainer.append(transferBtn, saveBtn, closeBtn);
                }
                
                billingModal.classList.add('show');
            }

            function closeModal() {
                billingModal.classList.remove('show');
                historyModal.classList.remove('show');
                confirmModal.classList.remove('show');
                bookingModal.classList.remove('show');
                dashboardModal.classList.remove('show');
                alertModal.classList.remove('show');
                managementModal.classList.remove('show');
                currentTransactionId = null;
                currentEditingHistoryId = null;
                editingTxBuffer = null;
                actionToConfirm = null;
            }
            
            function renderBillItems(tx) {
                billItemsList.innerHTML = '';
                tx.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'fnb-item';
                    itemEl.innerHTML = `<span>${item.name}</span><div class="fnb-controls"><button data-item-id="${item.id}" class="decrease-qty">-</button><span>${item.qty}</span><button data-item-id="${item.id}" class="increase-qty">+</button></div>`;
                    billItemsList.appendChild(itemEl);
                });
            }
            
            function handleQtyChange(itemId, change) {
                const tx = currentEditingHistoryId ? editingTxBuffer : appState.transactions.find(t => t.id === currentTransactionId);
                const item = tx.items.find(i => i.id === itemId);
                if (item) {
                    item.qty += change;
                    if (item.qty <= 0) tx.items = tx.items.filter(i => i.id !== itemId);
                }
                renderBillItems(tx);
                const newBill = calculateBill(tx);
                updateBillDisplay(newBill, tx.items);
            }

            function handleAttemptCloseBill() {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                if (tx.timer.mode === 'open' && tx.timer.startTime) {
                    // Stop the timer for open bills before payment
                    tx.timer.elapsed += (Date.now() - tx.timer.startTime) / 1000;
                    tx.timer.startTime = null;
                }
                
                const paidText = amountPaidInput.value.replace(/[^0-9]/g, '');
                const paid = paidText ? parseInt(paidText, 10) : 0;
                const totalText = document.getElementById('bill-total').textContent.replace(/[^0-9]/g, '');
                const total = totalText ? parseFloat(totalText) : 0;

                if (paid === 0) {
                    showCustomAlert('Jumlah bayar harus diisi terlebih dahulu.');
                    return;
                }
                if (paid < total) {
                    showCustomAlert('Jumlah bayar kurang dari total tagihan.');
                    return;
                }
                showConfirmation('closeBill');
            }

            function executeCloseBill() {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                const finalBill = calculateBill(tx);
                
                const completedTx = {
                    ...JSON.parse(JSON.stringify(tx)),
                    historyId: `hist-${Date.now()}`,
                    completedAt: Date.now(),
                    bill: finalBill,
                    paymentMethod: document.getElementById('payment-method').value
                };
                appState.completedTransactions.push(completedTx);
                
                appState.revenue.daily.total += finalBill.total;
                appState.revenue.monthly.total += finalBill.total;

                const completedDate = new Date(completedTx.completedAt).toISOString().split('T')[0];
                if (!appState.analytics[completedDate]) {
                    appState.analytics[completedDate] = { peakHours: {}, topItems: {} };
                }
                const hour = new Date(completedTx.completedAt).getHours();
                appState.analytics[completedDate].peakHours[hour] = (appState.analytics[completedDate].peakHours[hour] || 0) + 1;
                completedTx.items.forEach(item => {
                    appState.analytics[completedDate].topItems[item.name] = (appState.analytics[completedDate].topItems[item.name] || 0) + item.qty;
                });
                
                if (tx.isTakeAway) {
                    appState.transactions = appState.transactions.filter(t => t.id !== tx.id);
                } else {
                    const tableIndex = appState.transactions.findIndex(t => t.id === tx.id);
                    appState.transactions[tableIndex] = createEmptyTransaction(tx.id, tx.name);
                }
                
                saveState();
                updateRevenueDisplay();
                closeModal();
            }

            function handleSaveBill() {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                tx.customerName = customerNameInput.value;
                tx.customerType = customerTypeSelect.value;
                saveState();
                closeModal();
            }

            function executeUpdateHistory() {
                const historyIndex = appState.completedTransactions.findIndex(t => t.historyId === currentEditingHistoryId);
                const oldTotal = appState.completedTransactions[historyIndex].bill.total;

                const newBill = calculateBill(editingTxBuffer);
                editingTxBuffer.bill = newBill;
                const newTotal = newBill.total;

                const revenueDifference = newTotal - oldTotal;
                appState.revenue.daily.total += revenueDifference;
                appState.revenue.monthly.total += revenueDifference;
                
                appState.completedTransactions[historyIndex] = editingTxBuffer;

                saveState();
                updateRevenueDisplay();
                closeModal();
                openHistoryModal();
            }

            function openHistoryModal(filterDate = null) {
                historyTableBody.innerHTML = '';
                let transactionsToShow = [...appState.completedTransactions];
                if (filterDate) {
                    transactionsToShow = transactionsToShow.filter(tx => {
                        const txDate = new Date(tx.completedAt).toISOString().split('T')[0];
                        return txDate === filterDate;
                    });
                }

                if (transactionsToShow.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 6;
                    cell.textContent = 'Tidak ada riwayat transaksi pada tanggal ini.';
                    cell.style.textAlign = 'center';
                    cell.style.padding = '2rem';
                    cell.style.color = 'var(--subtle-text)';
                    row.appendChild(cell);
                    historyTableBody.appendChild(row);
                } else {
                    transactionsToShow.reverse().forEach(tx => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDateTime(tx.completedAt)}</td>
                            <td>${tx.name}</td>
                            <td>${tx.customerName || '-'}</td>
                            <td>${formatCurrency(tx.bill.total)}</td>
                            <td>${tx.paymentMethod || 'Cash'}</td>
                            <td><button class="edit-history-btn" data-history-id="${tx.historyId}">Edit</button></td>
                        `;
                        historyTableBody.appendChild(row);
                    });
                }
                historyModal.classList.add('show');
            }

            function showConfirmation(action) {
                actionToConfirm = action;
                if (action === 'closeBill') {
                    confirmMessage.textContent = 'Apakah Anda yakin ingin menutup tagihan ini?';
                } else if (action === 'updateHistory') {
                    confirmMessage.textContent = 'Mengubah riwayat akan merealkulasi pendapatan. Lanjutkan?';
                }
                confirmYesBtn.textContent = 'Ya, Lanjutkan';
                confirmModal.classList.add('show');
            }
            
            function showCustomAlert(message) {
                alertMessage.textContent = message;
                alertModal.classList.add('show');
            }

            // --- WAITING LIST FUNCTIONS ---
            function renderWaitingList() {
                waitingListContainer.innerHTML = '';
                appState.waitingList.forEach((customer, index) => {
                    const li = document.createElement('li');
                    li.className = 'waiting-list-item';
                    li.innerHTML = `
                        <span>${index + 1}. ${customer.name}</span>
                        <button data-index="${index}" title="Hapus dari daftar tunggu">&times;</button>
                    `;
                    waitingListContainer.appendChild(li);
                });
            }

            function executeAssignFromWaitingList() {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                const nextCustomer = appState.waitingList.shift();
                tx.customerName = nextCustomer.name;
                renderWaitingList();
                saveState();
                closeModal();
                openBillingModal(tx.id);
            }
            
            function executeAssignFromBooking() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                const bookingIndex = appState.bookings.findIndex(b => b.tableId === currentTransactionId && b.date === todayStr);
                if (bookingIndex === -1) return;

                const booking = appState.bookings[bookingIndex];
                const tx = appState.transactions.find(t => t.id === currentTransactionId);

                tx.customerName = booking.customerName;
                tx.bill.deposit = booking.deposit;

                appState.bookings.splice(bookingIndex, 1);
                
                saveState();
                renderTables();
                closeModal();
                openBillingModal(tx.id);
            }

            // --- BOOKING FUNCTIONS ---
            function openBookingModal() {
                renderBookings();
                bookingModal.classList.add('show');
            }
            
            function renderBookings() {
                bookingList.innerHTML = '';
                const sortedBookings = [...appState.bookings].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
                
                if(sortedBookings.length === 0) {
                    bookingList.innerHTML = '<p style="color: var(--subtle-text);">Belum ada reservasi.</p>';
                    return;
                }

                sortedBookings.forEach(booking => {
                    const item = document.createElement('div');
                    item.className = 'booking-list-item';
                    item.innerHTML = `
                        <div>
                            <strong>${booking.customerName}</strong><br>
                            <small>${booking.tableName} - ${formatDateTime(booking.dateTime)}</small>
                            ${booking.deposit > 0 ? `<br><small>Deposit: ${formatCurrency(booking.deposit)}</small>` : ''}
                        </div>
                        <button class="delete-booking-btn" data-booking-id="${booking.id}">&times;</button>
                    `;
                    bookingList.appendChild(item);
                });
            }

            function handleAddBooking(e) {
                e.preventDefault();
                const name = document.getElementById('booking-name').value;
                const tableId = document.getElementById('booking-table').value;
                const date = document.getElementById('booking-date').value;
                const time = document.getElementById('booking-time').value;
                const depositValue = bookingDepositInput.value.replace(/[^0-9]/g, '');
                const deposit = depositValue ? parseFloat(depositValue) : 0;

                if (!name || !tableId || !date || !time) {
                    showCustomAlert('Nama, Meja, Tanggal, dan Jam harus diisi!');
                    return;
                }

                const bookingDateTime = new Date(`${date}T${time}`);
                
                const conflict = appState.bookings.find(b => 
                    b.tableId === tableId && 
                    Math.abs(new Date(b.dateTime) - bookingDateTime) < (2 * 60 * 60 * 1000)
                );

                if (conflict) {
                    showCustomAlert('Jadwal bentrok! Meja sudah dibooking pada waktu yang berdekatan.');
                    return;
                }

                const newBooking = {
                    id: `book-${Date.now()}`,
                    customerName: name, tableId,
                    tableName: `Meja ${tableId.split('-')[1]}`,
                    date, time, deposit,
                    dateTime: bookingDateTime.toISOString()
                };

                appState.bookings.push(newBooking);
                saveState();
                renderBookings();
                renderTables();
                bookingForm.reset();
            }

            function handleDeleteBooking(bookingId) {
                appState.bookings = appState.bookings.filter(b => b.id !== bookingId);
                saveState();
                renderBookings();
                renderTables();
            }

            // --- DASHBOARD FUNCTIONS ---
            function openDashboardModal() {
                const today = new Date().toISOString().split('T')[0];
                dashboardDateFilter.value = today;
                renderAnalyticsDashboard(today);
                dashboardModal.classList.add('show');
            }

            function renderAnalyticsDashboard(date) {
                const analyticsData = appState.analytics[date] || { peakHours: {}, topItems: {} };

                // 1. Peak Hours Chart
                peakHoursChart.innerHTML = '';
                const peakData = analyticsData.peakHours;
                const businessHours = [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0, 1, 2];
                const maxTransactions = Math.max(1, ...businessHours.map(h => peakData[h] || 0));

                businessHours.forEach(hour => {
                    const transactions = peakData[hour] || 0;
                    const barHeight = (transactions / maxTransactions) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = `${barHeight}%`;
                    bar.innerHTML = `<span>${hour}</span>`;
                    peakHoursChart.appendChild(bar);
                });

                // 2. Top Selling Items
                const topItemsData = analyticsData.topItems;
                const sortedItems = Object.entries(topItemsData).sort(([,a],[,b]) => b - a).slice(0, 5);
                renderPieChart(sortedItems);
                
                // 3. Occupancy Rate (Real-time)
                const inUseTables = appState.transactions.filter(t => !t.isTakeAway && t.status === 'in-use').length;
                const occupancy = Math.round((inUseTables / TOTAL_TABLES) * 100);
                occupancyRateEl.textContent = `${occupancy}%`;

                // 4. Smart Alerts (Real-time)
                smartAlertsEl.innerHTML = '';
                const recentlyClosed = appState.completedTransactions.filter(tx => !tx.isTakeAway && !tx.cleaned && (Date.now() - tx.completedAt < 10 * 60 * 1000));
                if(recentlyClosed.length > 0) {
                     recentlyClosed.forEach(tx => {
                        const alertEl = document.createElement('div');
                        alertEl.className = 'smart-alert-item';
                        alertEl.textContent = `🔔 ${tx.name} perlu dibersihkan.`;
                        smartAlertsEl.appendChild(alertEl);
                     });
                } else {
                    smartAlertsEl.innerHTML = '<p style="color: var(--subtle-text);">Tidak ada notifikasi saat ini.</p>';
                }
            }

            function renderPieChart(data) {
                pieChartEl.innerHTML = '';
                pieChartLegendEl.innerHTML = '';
                if (data.length === 0) {
                    pieChartEl.style.background = 'none';
                    pieChartEl.innerHTML = '<p style="color: var(--text-color); text-align: center; width: 100%; font-size: 1.1rem; padding-top: 60px;">Tidak Ada Data</p>';
                    return;
                }

                const colors = ['#00bfa6', '#ff9800', '#ff5252', '#3498db', '#9b59b6'];
                const totalValue = data.reduce((sum, [, value]) => sum + value, 0);
                let cumulativePercent = 0;
                let gradientParts = [];

                data.forEach(([label, value], index) => {
                    const percent = (value / totalValue) * 100;
                    const color = colors[index % colors.length];
                    
                    if (index > 0) {
                        gradientParts.push(`${color} ${cumulativePercent}%`);
                    }
                    cumulativePercent += percent;
                    gradientParts.push(`${color} ${cumulativePercent}%`);

                    const legendItem = document.createElement('li');
                    legendItem.innerHTML = `<div class="legend-color-box" style="background-color: ${color};"></div> ${label} (${value})`;
                    pieChartLegendEl.appendChild(legendItem);
                });

                pieChartEl.style.background = `conic-gradient(${gradientParts.join(', ')})`;
            }

            // --- MANAGEMENT FUNCTIONS ---
            function openManagementModal() {
                managementModalTitle.textContent = `Transfer Sesi dari ${appState.transactions.find(tx => tx.id === currentTransactionId).name}`;
                managementModalContent.innerHTML = '<p>Pilih meja tujuan (hanya meja kosong yang ditampilkan):</p>';
                
                const availableTables = appState.transactions.filter(tx => tx.status === 'available' && !tx.isTakeAway);
                
                if (availableTables.length === 0) {
                    managementModalContent.innerHTML += '<p style="color: var(--warning-color); margin-top: 1rem;">Tidak ada meja kosong tersedia.</p>';
                } else {
                    const grid = document.createElement('div');
                    grid.className = 'management-grid';
                    availableTables.forEach(table => {
                        const card = document.createElement('div');
                        card.className = 'management-card';
                        card.dataset.id = table.id;
                        card.innerHTML = `<h5>${table.name}</h5>`;
                        card.onclick = () => {
                            document.querySelectorAll('.management-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                        };
                        grid.appendChild(card);
                    });
                    managementModalContent.appendChild(grid);
                }
                managementModal.classList.add('show');
            }

            function executeTransfer() {
                const targetCard = document.querySelector('.management-card.selected');
                if (!targetCard) {
                    showCustomAlert("Pilih meja tujuan terlebih dahulu.");
                    return;
                }
                const targetTableId = targetCard.dataset.id;

                const sourceIndex = appState.transactions.findIndex(tx => tx.id === currentTransactionId);
                const targetIndex = appState.transactions.findIndex(tx => tx.id === targetTableId);

                if (sourceIndex === -1 || targetIndex === -1) {
                    showCustomAlert("Terjadi kesalahan, meja tidak ditemukan.");
                    return;
                }

                const sourceTxData = JSON.parse(JSON.stringify(appState.transactions[sourceIndex]));
                const targetTxData = appState.transactions[targetIndex];

                appState.transactions[targetIndex] = {
                    ...sourceTxData,
                    id: targetTxData.id,
                    name: targetTxData.name
                };

                appState.transactions[sourceIndex] = createEmptyTransaction(currentTransactionId, `Meja ${currentTransactionId.split('-')[1]}`);
                
                saveState();
                renderTables();
                closeModal();
                showCustomAlert(`Sesi berhasil ditransfer ke ${targetTxData.name}.`);
            }

            function generateDurationOptions() {
                fixedDurationSelect.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const minutes = i * 10;
                    const option = document.createElement('option');
                    option.value = minutes / 60;
                    option.textContent = `${minutes} Menit`;
                    fixedDurationSelect.appendChild(option);
                }
                for (let i = 1; i <= 10; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} Jam`;
                    if (i === 1) option.selected = true;
                    fixedDurationSelect.appendChild(option);
                }
            }

            // --- EVENT LISTENERS ---
            modalCloseBtn.addEventListener('click', closeModal);
            billingModal.addEventListener('click', (e) => { if(e.target === billingModal) closeModal(); });
            historyModalCloseBtn.addEventListener('click', closeModal);
            historyModal.addEventListener('click', (e) => { if(e.target === historyModal) closeModal(); });
            historyBtn.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                historyDateFilter.value = today;
                openHistoryModal(today);
            });
            historyDateFilter.addEventListener('change', (e) => openHistoryModal(e.target.value));

            bookingBtn.addEventListener('click', openBookingModal);
            bookingModalCloseBtn.addEventListener('click', closeModal);
            bookingForm.addEventListener('submit', handleAddBooking);
            bookingList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-booking-btn')) {
                    handleDeleteBooking(e.target.dataset.bookingId);
                }
            });
            bookingDepositInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value ? formatCurrency(parseInt(value, 10)).replace(',00', '') : '';
            });

            dashboardBtn.addEventListener('click', openDashboardModal);
            dashboardModalCloseBtn.addEventListener('click', closeModal);
            dashboardDateFilter.addEventListener('change', (e) => renderAnalyticsDashboard(e.target.value));
            headerRevenueWidget.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                historyDateFilter.value = today;
                openHistoryModal(today);
            });
            alertOkBtn.addEventListener('click', () => alertModal.classList.remove('show'));
            managementModalCloseBtn.addEventListener('click', closeModal);
            managementConfirmBtn.addEventListener('click', () => {
                if (managementAction === 'transfer') {
                    executeTransfer();
                }
            });

            confirmNoBtn.addEventListener('click', () => {
                if (actionToConfirm === 'assignFromWaitingList' || actionToConfirm === 'assignFromBooking') {
                    const txIdToOpen = currentTransactionId;
                    closeModal();
                    openBillingModal(txIdToOpen);
                } else {
                    closeModal();
                }
            });
            confirmYesBtn.addEventListener('click', () => {
                if (actionToConfirm === 'closeBill') {
                    executeCloseBill();
                } else if (actionToConfirm === 'updateHistory') {
                    executeUpdateHistory();
                } else if (actionToConfirm === 'assignFromWaitingList') {
                    executeAssignFromWaitingList();
                } else if (actionToConfirm === 'assignFromBooking') {
                    executeAssignFromBooking();
                }
            });

            historyTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-history-btn')) {
                    const historyId = e.target.dataset.historyId;
                    const historyTx = appState.completedTransactions.find(t => t.historyId === historyId);
                    if (historyTx) {
                        closeModal();
                        openBillingModal(null, true, historyTx);
                    }
                }
            });
            
            timerModeSelect.addEventListener('change', (e) => {
                fixedDurationGroup.style.display = e.target.value === 'fixed' ? 'block' : 'none';
            });
            
            startTimerBtn.addEventListener('click', () => {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                if (!tx || tx.status === 'in-use') return;
                tx.status = 'in-use';
                tx.timer.mode = timerModeSelect.value;
                tx.timer.startTime = Date.now();
                tx.timer.elapsed = 0;
                if (tx.timer.mode === 'fixed') {
                    tx.timer.duration = parseFloat(fixedDurationSelect.value) * 3600;
                }
                startTimerBtn.disabled = true;
                addTimeBtn.disabled = tx.timer.mode !== 'fixed';
                updateBillDisplay(calculateBill(tx), tx.items);
            });
            
            addTimeBtn.addEventListener('click', () => {
                const tx = appState.transactions.find(t => t.id === currentTransactionId);
                if (!tx || tx.status !== 'in-use' || tx.timer.mode !== 'fixed') return;
                tx.timer.duration += 3600; // Selalu tambah 1 jam
                updateBillDisplay(calculateBill(tx), tx.items);
            });

            fnbMenuGrid.addEventListener('click', (e) => {
                const target = e.target.closest('.fnb-menu-item');
                if (!target) return;

                const itemId = parseInt(target.dataset.itemId, 10);
                const tx = currentEditingHistoryId ? editingTxBuffer : appState.transactions.find(t => t.id === currentTransactionId);
                const menuItem = FNB_MENU.find(item => item.id === itemId);
                const existingItem = tx.items.find(i => i.id === itemId);

                if (existingItem) {
                    existingItem.qty++;
                } else {
                    tx.items.push({ ...menuItem, qty: 1 });
                }
                renderBillItems(tx);
                const newBill = calculateBill(tx);
                updateBillDisplay(newBill, tx.items);
            });

            billItemsList.addEventListener('click', (e) => {
                const itemId = parseInt(e.target.dataset.itemId, 10);
                if(e.target.classList.contains('increase-qty')) handleQtyChange(itemId, 1);
                else if(e.target.classList.contains('decrease-qty')) handleQtyChange(itemId, -1);
            });

            amountPaidInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value ? formatCurrency(parseInt(value, 10)).replace(',00', '') : '';
                updateChange();
            });
            
            [customerNameInput, customerTypeSelect].forEach(el => {
                el.addEventListener('change', () => {
                    const tx = currentEditingHistoryId ? editingTxBuffer : appState.transactions.find(t => t.id === currentTransactionId);
                    tx.customerName = customerNameInput.value;
                    tx.customerType = customerTypeSelect.value;
                    const newBill = calculateBill(tx);
                    updateBillDisplay(newBill, tx.items);
                });
            });

            takeAwayBtn.addEventListener('click', () => {
                const id = `takeaway-${Date.now()}`;
                const newTakeAway = createEmptyTransaction(id, 'Transaksi Langsung');
                appState.transactions.push(newTakeAway);
                openBillingModal(id);
            });

            // WAITING LIST EVENT LISTENERS
            addToWaitingListBtn.addEventListener('click', () => {
                const name = waitingListNameInput.value.trim();
                if (name) {
                    appState.waitingList.push({ name: name, addedAt: Date.now() });
                    waitingListNameInput.value = '';
                    renderWaitingList();
                    saveState();
                }
            });

            waitingListContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const index = parseInt(e.target.dataset.index, 10);
                    appState.waitingList.splice(index, 1);
                    renderWaitingList();
                    saveState();
                }
            });

            // --- INISIALISASI ---
            function init() {
                loadState();
                generateDurationOptions();
                
                FNB_MENU.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'fnb-menu-item';
                    itemEl.dataset.itemId = item.id;
                    itemEl.innerHTML = `<div>${item.name}</div><div class="price">${formatCurrency(item.price)}</div>`;
                    fnbMenuGrid.appendChild(itemEl);
                });

                for (let i = 1; i <= TOTAL_TABLES; i++) {
                    const option = document.createElement('option');
                    option.value = `table-${i}`;
                    option.textContent = `Meja ${i}`;
                    bookingTableSelect.appendChild(option);
                }

                mainInterval = setInterval(() => {
                    updateClock();
                    renderTables();
                }, 1000);
                updateRevenueDisplay();
                renderTables();
                renderWaitingList();
            }

            init();
        });
    </script>
</body>
</html>
